" vim: set ft=vim ts=2 sw=2 sts=2 et foldmethod=marker:
"
" 操作全般
"
" ノーマルモード: type [s]
" 編集モード: type [ctrl] + [f]
"
" メモ
"   aaa: 設定ファイルを開く
"   m: 履歴を開く
"   h,j,k,l: 分割ウィンドウを移動
"   H,J,K,L: 分割ウィンドウそのものを移動
"   g: 検索
"   gj: カーソル位置の単語で検索
"   gk: 検索結果を再開
"
" バッファ上
"   C-h C-c 閉じる
"
" 方針
"  プレフィックスとして使うキー
"  - s, <space>, m, t
nnoremap   [nora] <Nop>
nmap       s   [nora]
imap       <c-f> <ESC>[nora]
nmap       <c-f> <ESC>[nora]


" ウインドウ操作系
nnoremap  [nora:w] <nop>
nmap      <space>  [nora:w]
nnoremap  <silent> [nora:w]e :<C-u>VimFilerCreate -split -simple -winwidth=35 -no-quit<CR>
nnoremap  <silent> [nora:w]g :<C-u>GundoToggle<CR>
nnoremap  <silent> [nora:w]t :<C-u>TagbarToggle<CR>
nnoremap  <silent> [nora:w]r :<C-u>source %<CR>
nnoremap  [nora:w]s :<C-u>Git status<CR>
nnoremap  [nora:w]p :<C-u>Git push<CR>
nnoremap  [nora:w]a :<C-u>Git add %<CR>
nnoremap  [nora:w]c :<C-u>Git commit<CR>
nnoremap  [nora:w]d :<C-u>Git diff %<CR>
nnoremap  [nora:w]o :<C-u>Unite -no-quit -vertical -winwidth=30 outline<CR>

let g:unite_enable_start_insert=1
let g:unite_source_history_yank_enable =1
let g:unite_source_file_mru_limit = 200
nnoremap <silent> [nora]aaa :<C-u>tabe ~/.vim.d/config/controll<CR>


" 起動した場所のファイルリスト
nnoremap <silent> [nora]f :<C-u>Unite file file/new directory/new<CR>
nnoremap <silent> [nora]<C-f> :<C-u>Unite file file/new directory/new<CR>

" 履歴
"nnoremap <silent> [nora]h :<C-u>Unite file_mru<CR>
nnoremap <silent> [nora]<C-h> :<C-u>Unite file_mru<CR>

" バッファを開く
nnoremap <silent> [nora]b :<C-u>Unite buffer bookmark<CR>
nnoremap <silent> [nore]<C-b> :<C-u>Unite buffer bookmark<CR>

" 現在の位置でリストを開く
nnoremap <silent> [nora]c :<C-u>UniteWithBufferDir file file/new directory/new<CR>
nnoremap <silent> [nora]<C-c> :<C-u>UniteWithBufferDir file file/new directory/new<CR>

" アウトライン
nnoremap <silent> [nora]o :<C-u>Unite outline fold mark<CR>
nnoremap <silent> [nora]<C-o> :<C-u>Unite outline fold mark<CR>

" メモ
nnoremap <silent> [nora]q :<C-u>Unite qfixhowm qfixhowm/new <CR>
nnoremap <silent> [nora]<C-q> :<C-u>Unite qfixhowm qfixhowm/new <CR>

" ファイラを開く
nnoremap <silent> [nora]e :<C-u>VimFilerBufferDir -split -simple -winwidth=35 -no-quit<CR>
nnoremap <silent> [nora]<C-e> :<C-u>VimFilerBufferDir -split -simple -winwidth=35 -no-quit<CR>

" グレップ
" let g:unite_source_grep_command              = 'ag'
" let g:unite_source_grep_default_opts         = '--nocolor --nogroup'
" let g:unite_source_grep_recursive_opt        = ''
" let g:unite_source_grep_max_candidates       = 200
" let g:unite_source_file_mru_limit            = 200
" let g:unite_enable_start_insert              = 1
" let g:unite_source_history_yank_enable       = 1

" 検索
nnoremap [search] <nop>
nmap [nora]g [search]

nnoremap <silent> [search] :<C-u>Unite grep:. -buffer-name=search-buffer<CR>
" カーソル位置の単語で検索
nnoremap <silent> [search]j :<C-u>Unite grep:. -buffer-name=search-buffer<CR><C-R><C-W><CR>
" 検索の再開
nnoremap <silent> [search]k :<C-u>UniteResume search-buffer<CR>

autocmd FileType unite call s:unite_my_settings()
function! s:unite_my_settings()
    nnoremap <silent> <buffer> <expr> <C-T> unite#do_action('tabopen')
    inoremap <silent> <buffer> <expr> <C-T> unite#do_action('tabopen')
    nnoremap <silent> <buffer> <expr> <C-O> unite#do_action('split')
    inoremap <silent> <buffer> <expr> <C-O> unite#do_action('split')
    nnoremap <silent> <buffer> <expr> <C-V> unite#do_action('vsplit')
    inoremap <silent> <buffer> <expr> <C-V> unite#do_action('vsplit')
    inoremap <silent> <buffer> <expr> <C-V> unite#do_action('vsplit')
    nnoremap <silent> <buffer> <ESC><ESC> :q<CR>
    inoremap <silent> <buffer> <ESC><ESC> <ESC>:q<CR>
    imap <buffer> <C-k>     <Plug>(unite_select_previous_line)
    imap <buffer> <C-j>     <Plug>(unite_select_next_line)
endfunction

" 分割の移動
nnoremap [nora]j <C-w>j
nnoremap [nora]k <C-w>k
nnoremap [nora]l <C-w>l
nnoremap [nora]h <C-w>h 

" 分割の入れ替え
nnoremap [nora]J <C-w>J  
nnoremap [nora]K <C-w>K
nnoremap [nora]L <C-w>L
nnoremap [nora]H <C-w>H

" 分割のリサイズ 増やす
nnoremap [nora]= <C-w>=
nnoremap [nora]> <C-w>>
nnoremap [nora]< <C-w><
nnoremap [nora]+ <C-w>+
nnoremap [nora]- <C-w>-
call submode#enter_with('windowi', 'n', '', 's>', '<C-w>>')
call submode#enter_with('windowi', 'n', '', 's<', '<C-w><')
call submode#enter_with('windowi', 'n', '', 's+', '<C-w>+')
call submode#enter_with('windowi', 'n', '', 's-', '<C-w>-')
call submode#map('windowi', 'n', '', '>', '<C-w>>')
call submode#map('windowi', 'n', '', '<', '<C-w><')
call submode#map('windowi', 'n', '', '+', '<C-w>+')
call submode#map('windowi', 'n', '', '-', '<C-w>-')


" 閉じる
nnoremap <c-c> :q <enter>

" タブの移動
nnoremap [nora]T :<C-u>Unite tab<cr>

" プロジェクト操作
nnoremap [project] <nop>
nmap [nora]p [project]

let g:ctrlp_map = '<Nop>'
let g:ctrlp_working_path_mode = 'ra'
let g:ctrlp_open_new_file = 'r'
let g:ctrlp_extensions = ['tag', 'quickfix', 'dir', 'line', 'mixed']
let g:ctrlp_max_files  = 100000 " 対象ファイル最大数(default:10000)
let g:ctrlp_max_depth = 10 " 検索対象の最大階層数(default:40)
let g:ctrlp_clear_cache_on_exit = 0 " vim終了時にキャッシュクリアしない(default:1)
let g:ctrlp_match_window = 'bottom,order:btt,min:1,max:18,results:50' " 検索ウィンドウの設定

nnoremap [project] :<C-u>CtrlPCurWD<CR>
"nnoremap [nora]p :<C-u>CtrlP<CR>
" カレントバッファのルートを基準に検索
nnoremap [project]P :<C-u>CtrlPRoot<CR>
" カレントバッファを基準に検索
nnoremap [project]p :<C-u>CtrlPCurWD<CR>
" 履歴からファイルを探す
nnoremap [project]m :<C-u>CtrlPMRUFiles<CR> 
nnoremap [nora]m :<C-u>CtrlPMRUFiles<CR> 
nnoremap [project]q :<C-u>CtrlPQuickfix<CR>
nnoremap [project]t :<C-u>CtrlPTag<CR>

" HTML操作
nmap [nora]et <Plug>(endtagcomment)



" Vimshell
nnoremap   [vimshell]   <Nop>
nmap       [nora]s          [vimshell]

nnoremap <silent> [vimshell]s :VimShell<CR>
nnoremap <silent> [vimshell]t :VimShellTab<CR>
nnoremap <silent> [vimshell]iphp :VimShellInteractive php<CR>
vmap <silent> [vimshell]s :VimShellSendString<C-Right>


" 辞書: vim-ref
nnoremap [ref] <Nop>
nmap [nora]r [ref]

"Ref webdictでalcを使う設定
let g:ref_source_webdict_cmd = 'lynx -dump -nonumbers %s'
"let g:ref_source_webdict_use_cache = 1
let g:ref_source_webdict_sites = {
            \ 'alc' : {
            \   'url' : 'http://eow.alc.co.jp/%s/UTF-8/',
            \   'cache' : 1
            \   },
            \ 'wiktionary' : {
            \   'url' : 'http://ja.wiktionary.org/wiki/%s',
            \   'keyword_encoding': 'utf-8',
            \   'cache' : 1
            \   }
            \ }
function! g:ref_source_webdict_sites.alc.filter(output)
      return join(split(a:output, "\n")[42 :], "\n")
endfunction

"
" 辞書 
"
" vimshell% cd ~/.vim/
" vimshell% curl -sSL "http://jp1.php.net/get/php_manual_ja.tar.gz/from/this/mirror" | tar zxvf -
"
let g:ref_phpmanual_path = "/opt/vim/php-chunked-xhtml/"
nmap [ref]a :<C-u>Ref webdict alc 
nmap [ref]w :<C-u>Ref webdict wiktionary 
nmap [ref]p :<C-u>Ref phpmanual 


" Unite
nnoremap [unite] <Nop>
nmap [nora]u [unite]

nnoremap <silent> [unite]y :<C-u>Unite history/yank<CR>
nnoremap <silent> [unite]b :<C-u>Unite buffer<CR>
nnoremap <silent> [unite]f :<C-u>UniteWithBufferDir -buffer-name=files file<CR>
nnoremap <silent> [unite]r :<C-u>Unite -buffer-name=register register<CR>
nnoremap <silent> [unite]u :<C-u>Unite file_mru buffer<CR>


"
" Snipet
" imap <expr><TAB> neocomplcache#sources#snippets_complete#expandable() ? "\<Plug>(neocomplcache_snippets_expand)" : pumvisible() ? "\<C-n>" : "\<TAB>"
" smap <expr><TAB> neocomplcache#sources#snippets_complete#expandable() ? "\<Plug>(neocomplcache_snippets_expand)" : pumvisible() ? "\<C-n>" : "\<TAB>"
" let g:neocomplcache_snippets_dir = $HOME . '/.vim/snippets'
" fun! Filename(...)
" let filename = expand('%:t:r')
" if filename == '' | return a:0 == 2 ? a:2 : '' | endif
" return !a:0 || a:1 == '' ? filename : substitute(a:1, '$1', filename, 'g')
" endf
"
"
" Plugin key-mappings.
imap <C-k>     <Plug>(neosnippet_expand_or_jump)
smap <C-k>     <Plug>(neosnippet_expand_or_jump)
xmap <C-k>     <Plug>(neosnippet_expand_target)
 
" SuperTab like snippets behavior.
" imap <expr><TAB> neosnippet#expandable_or_jumpable() ?
" \ "\<Plug>(neosnippet_expand_or_jump)"
" \: pumvisible() ? "\<C-n>" : "\<TAB>"
" smap <expr><TAB> neosnippet#expandable_or_jumpable() ?
" \ "\<Plug>(neosnippet_expand_or_jump)"
" \: "\<TAB>"

let g:neosnippet#snippets_directory='~/.dotfiles/vim/snippets/'
nnoremap [snipet] <nop>
nmap [nora]sn [snipet]
nnoremap <silent> [snipet]e :<c-u>NeoSnippetEdit<cr>
nnoremap <silent> [snipet] :<c-u>NeoSnippetEdit<cr>

" For snippet_complete marker.
if has('conceal')
  set conceallevel=2 concealcursor=i
endif


" メモ機能
"set QFixHowm_Key = '<nop>'
 
let howm_dir             = '~/memo/hown'

" マークダウン記法を使う
"let QFixHowm_FileType = 'markdown'
"let QFixHowm_Title = '#'
"let QFixMRU_Title = {}
"let QFixMRU_Title['mkd']       = '^###[^#]'
"let QFixMRU_Title['mkd_regxp'] = '^###[^#]'
au BufRead,BufNewFile *.md set filetype=markdown

" qfixhowm {{{
" ファイル拡張子をmdにする
let howm_filename = '%Y/%m/%Y-%m-%d-%H%M%S.md'
" ファイルタイプをmarkdownにする
let QFixHowm_FileType = 'markdown'
" タイトル記号
" let QFixHowm_Title = '#'
" タイトル行検索正規表現の辞書を初期化
let QFixMRU_Title = {}
" MRUでタイトル行とみなす正規表現(Vimの正規表現で指定)
let QFixMRU_Title['mkd'] = '^###[^#]'
" grepでタイトル行とみなす正規表現(使用するgrepによっては変更する必要があります)
let QFixMRU_Title['mkd_regxp'] = '^###[^#]'
" }}}

"le howm_filename        = '%Y/%m/%Y-%m-%d-%H%M%S.txt'
"let howm_fileencoding    = 'utf8'
"let howm_fileformat      = 'linux'
"
"
" ジャンクファイル
" JunkFile {{{
" http://vim-users.jp/2010/11/hack181/
"" Open junk file.
command! -nargs=0 JunkFile call s:open_junk_file()
function! s:open_junk_file()
    let l:junk_dir = $HOME . '/.vim_junk'. strftime('/%Y/%m')
    if !isdirectory(l:junk_dir)
        call mkdir(l:junk_dir, 'p')
    endif

    let l:filename = input('Junk Code: ', l:junk_dir.strftime('/%Y-%m-%d-%H%M%S.'))
    if l:filename != ''
        execute 'edit ' . l:filename
    endif
endfunction
" }}}

let g:memolist_qfixgrep = 1
let g:memolist_memo_suffix = "md"
let g:memolist_memo_date = "%Y-%m-%d %H:%M"
let g:memolist_memo_date = "epoch"
let g:memolist_memo_date = "%d %t"
let g:memolist_prompt_tags = 1
let g:memolist_prompt_categories = 1
let g:memolist_qfixgrep = 1
let g:memolist_vimfiler = 1
let g:memolist_template_dir_path = "~/memo/memolist"
map [nora]ml  :memolist<cr>
map [nora]mn  :memonew<cr>
map [nora]mg  :memogrep<cr>


" vimfile {{{
call unite#custom_default_action('source/bookmark/directory' , 'vimfiler')
"call unite#custom_default_action("directory", "VimFilerExplorer")
"call unite#custom_default_action("directory_mru", "VimFilerExplorer")
let g:vimfiler_as_default_explorer = 1
let g:vimfiler_safe_mode_by_default = 0
nnoremap <silent> [nora]fe :<c-u>vimfilerbufferdir -quit<cr>
nnoremap <silent> [nora]fi :<c-u>vimfilerbufferdir -split -simple -winwidth=35 -no-quit<cr>
augroup vimrc
  autocmd filetype vimfiler call s:vimfiler_my_settings()
augroup end
function! s:vimfiler_my_settings()
    "call unite#custom_default_action('directory','vimfilerbufferdir')
    "call unite#custom_default_action('directory','lcd')
    "call unite#custom_default_action('directory', 'cd')

    nmap <buffer> <cr> <plug>(vimfiler_expand)
    nmap <buffer> q <plug>(vimfiler_exit)
    nmap <buffer> q <plug>(vimfiler_hide)
    nnoremap <buffer><silent>/ :call UniteFileCurrentDir()<CR>
endfunction

function! UniteFileCurrentDir()
  let s  = ':Unite file -start-insert -path='
  let s .= vimfiler#get_current_vimfiler().current_dir

  execute s
endfunction
"}}}
"
"
"set virtualedit=all     " カーソルを文字が存在しない部分でも動けるようにする
set hidden              " バッファを閉じる代わりに隠す（Undo履歴を残すため）
"set switchbuf=useopen   " 新しく開く代わりにすでに開いてあるバッファを開く
set showmatch           " 対応する括弧などをハイライト表示する
set matchtime=3         " 対応括弧のハイライト表示を3秒にする
" 対応括弧に'<'と'>'のペアを追加
set matchpairs& matchpairs+=<:>
set noswapfile
" デフォルト不可視文字は美しくないのでUnicodeで綺麗に
set listchars=tab:»-,trail:-,extends:»,precedes:«,nbsp:%,eol:↲

" カーソル下の単語を * で検索
vnoremap <silent> * "vy/\V<C-r>=substitute(escape(@v, '\/'), "\n", '\\n', 'g')<CR><CR>
"
" " 検索後にジャンプした際に検索単語を画面中央に持ってくる
nnoremap n nzz
nnoremap N Nzz
nnoremap * *zz
nnoremap # #zz
nnoremap g* g*zz
nnoremap g# g#zz

" vを二回で行末まで選択
vnoremap v $h

"nmap <s-k> <c-w>+
"nmap <s-j> <c-w>-
"nmap <s-h> <c-w><
"nmap <s-l> <c-w>>

NeoBundleLazy "sjl/gundo.vim", {
      \ "autoload": {
      \   "commands": ['GundoToggle'],
      \}}
nnoremap <Leader>g :GundoToggle<CR>

NeoBundleLazy 'majutsushi/tagbar', {
      \ "autload": {
      \   "commands": ["TagbarToggle"],
      \ },
      \ "build": {
      \   "mac": "brew install ctags",
      \ }}
nmap <Leader>t :TagbarToggle<CR>


" 要整理
" ref @ http://lambdalisue.hatenablog.com/entry/2013/06/23/071344 "


" Use vsplit mode
if has("vim_starting") && !has('gui_running') && has('vertsplit')
  function! g:EnableVsplitMode()
    " enable origin mode and left/right margins
    let &t_CS = "y"
    let &t_ti = &t_ti . "\e[?6;69h"
    let &t_te = "\e[?6;69l\e[999H" . &t_te
    let &t_CV = "\e[%i%p1%d;%p2%ds"
    call writefile([ "\e[?6;69h" ], "/dev/tty", "a")
  endfunction

  " old vim does not ignore CPR
  map <special> <Esc>[3;9R <Nop>

  " new vim can't handle CPR with direct mapping
  " map <expr> ^[[3;3R g:EnableVsplitMode()
  set t_F9=[3;3R
  map <expr> <t_F9> g:EnableVsplitMode()
  let &t_RV .= "\e[?6;69h\e[1;3s\e[3;9H\e[6n\e[0;0s\e[?6;69l"
endif

set lazyredraw
set ttyfast
